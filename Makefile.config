# Only test the currently used features and
# display them.
FEATURE_TESTS ?= libelf lzma zlib btf-vmlinux cplus-demangle cxa-demangle libtcmalloc rpmalloc
FEATURE_DISPLAY := $(FEATURE_TESTS) demangle
FEATURE_GROUP_MEMBERS-demangle = cplus-demangle cxa-demangle

# Python embedding flags
ifndef NO_LIBPYTHON
  PYTHON ?= python3
  PYTHON_CONFIG ?= $(PYTHON)-config
  PYTHON_EMBED_CCOPTS := $(shell $(PYTHON_CONFIG) --includes 2>/dev/null)
  PYTHON_EMBED_LDOPTS := $(shell ($(PYTHON_CONFIG) --libs --embed &>/dev/null && $(PYTHON_CONFIG) --libs --embed 2>/dev/null) || $(PYTHON_CONFIG) --libs 2>/dev/null)
  PYTHON_EMBED_LDFLAGS := $(shell ($(PYTHON_CONFIG) --ldflags --embed &>/dev/null && $(PYTHON_CONFIG) --ldflags --embed 2>/dev/null) || $(PYTHON_CONFIG) --ldflags 2>/dev/null)
  # python-build-standalone support: add rpath and PYTHONHOME when PYTHON= is specified
  ifeq ($(origin PYTHON),command line)
    PYTHON_PREFIX := $(shell $(PYTHON_CONFIG) --prefix 2>/dev/null)
    PYTHON_LIBDIR := $(PYTHON_PREFIX)/lib
    ifneq ($(wildcard $(PYTHON_LIBDIR)/libpython3*.so),)
      PYTHON_EMBED_LDFLAGS += -Wl,-rpath,$(PYTHON_LIBDIR)
    endif
  endif
  FEATURE_CHECK_CFLAGS-libpython := $(PYTHON_EMBED_CCOPTS)
  FEATURE_CHECK_LDFLAGS-libpython := $(PYTHON_EMBED_LDFLAGS) $(PYTHON_EMBED_LDOPTS)
  FEATURE_TESTS += libpython
  FEATURE_DISPLAY += libpython
endif

include $(srctree)/build/Makefile.feature

$(shell printf "" > $(OUTPUT).config-detected)
detected     = $(shell echo "$(1)=y"       >> $(OUTPUT).config-detected)
detected_var = $(shell echo "$(1)=$($(1))" >> $(OUTPUT).config-detected)
detected_override = $(shell echo "override $(1)=y" >> $(OUTPUT).config-detected)

################################

ifeq ($(feature-libelf), 1)
    $(call detected,CONFIG_LIBELF)
else
    $(error ERROR: No libelf found. Please install libelf-dev, libelf-devel, elfutils-libelf-devel.)
endif

ifeq ($(feature-lzma), 1)
    override CFLAGS += -DHAVE_LZMA_SUPPORT
    override CXXFLAGS += -DHAVE_LZMA_SUPPORT
    $(call detected,CONFIG_LZMA)
else
    $(warning No liblzma found, disables MiniDebugInfo decompression, please install xz-devel/liblzma-dev)
endif

ifeq ($(feature-zlib), 1)
    $(call detected,CONFIG_ZLIB)
endif

ifeq ($(feature-btf-vmlinux), 1)
    override CFLAGS += -DCONFIG_LIBBPF
    # Overrides the make command line option
    # `make CONFIG_LIBBPF=1`.
    $(call detected_override,CONFIG_LIBBPF)
endif

ifeq ($(feature-cplus-demangle), 1)
    override CFLAGS += -DHAVE_CPLUS_DEMANGLE_SUPPORT
    override CXXFLAGS += -DHAVE_CPLUS_DEMANGLE_SUPPORT
    $(call detected,CONFIG_CPLUS_DEMANGLE)
else
    ifeq ($(feature-cxa-demangle), 1)
        override CFLAGS += -DHAVE_CXA_DEMANGLE_SUPPORT
        override CXXFLAGS += -DHAVE_CXA_DEMANGLE_SUPPORT
        $(call detected,CONFIG_CXX_DEMANGLE)
    endif
endif

ifeq ($(feature-libtcmalloc), 1)
    override CFLAGS += -DHAVE_LIBTCMALLOC
    override CXXFLAGS += -DHAVE_LIBTCMALLOC
    $(call detected,CONFIG_LIBTCMALLOC)
else ifeq ($(feature-rpmalloc), 1)
    override CFLAGS += -DHAVE_RPMALLOC
    override CXXFLAGS += -DHAVE_RPMALLOC
    $(call detected,CONFIG_RPMALLOC)
endif

ifndef NO_LIBPYTHON
  ifeq ($(feature-libpython), 1)
    override CFLAGS += -DHAVE_LIBPYTHON
    override CFLAGS += $(PYTHON_EMBED_CCOPTS)
    $(call detected,CONFIG_LIBPYTHON)
    $(call detected_var,PYTHON_EMBED_LDOPTS)
    $(call detected_var,PYTHON_EMBED_LDFLAGS)
    ifneq ($(PYTHON_PREFIX),)
      $(call detected_var,PYTHON_PREFIX)
    endif
  else
    $(warning No libpython found, disables Python profiler, please install python3-devel/python3-dev)
  endif
else
    $(warning Disabling Python profiler per NO_LIBPYTHON=1)
endif
