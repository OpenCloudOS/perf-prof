# hrcount/stat - 高精度/低精度周期计数器
周期性统计事件发生次数，支持毫秒/微秒级计数粒度。

## 概述
- **主要用途**: 周期性统计 tracepoint 事件的发生次数，hrcount 提供毫秒/微秒级高精度计数，stat 提供低精度但支持进程级监控
- **适用场景**: 事件频率统计、系统行为趋势观察、周期性计数监控
- **功能分类**: 自定义事件类，计数分析
- **最低内核版本**: 3.10+
- **平台支持**: 所有支持 perf_event 的架构
- **特殊限制**:
  - hrcount 只能附加到 CPU（-C），不能附加到进程（-p）
  - stat 支持 CPU 和进程两种附加方式
- **参与联合分析**: 不参与联合分析，独立使用

## 核心原理

### hrcount 高精度计数原理

hrcount 利用 hrtimer 定时器实现高精度计数：

```
┌─────────────────────────────────────────────────────────────────┐
│                         hrcount 架构                            │
├─────────────────────────────────────────────────────────────────┤
│  内核态                                                         │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  CPU 0                    CPU 1                         │   │
│  │  ┌─────────────┐          ┌─────────────┐              │   │
│  │  │ hrtimer     │          │ hrtimer     │              │   │
│  │  │ (leader)    │          │ (leader)    │              │   │
│  │  │ --period    │          │ --period    │              │   │
│  │  ├─────────────┤          ├─────────────┤              │   │
│  │  │ event1 cnt  │          │ event1 cnt  │              │   │
│  │  │ event2 cnt  │          │ event2 cnt  │              │   │
│  │  └──────┬──────┘          └──────┬──────┘              │   │
│  │         │ 同时采样                │ 同时采样            │   │
│  │         ▼                        ▼                     │   │
│  │  PERF_SAMPLE_READ         PERF_SAMPLE_READ             │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
├──────────────────────────────┼──────────────────────────────────┤
│  用户态                      ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    perf ringbuffer                       │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │   │
│  │  │ sample 1 │ │ sample 2 │ │ sample 3 │ │ sample N │   │   │
│  │  └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘   │   │
│  └───────┼────────────┼────────────┼────────────┼───────────┘   │
│          │            │            │            │               │
│          ▼            ▼            ▼            ▼               │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    count_dist 累计                       │   │
│  │  按 --period 粒度统计每个时间槽的计数                    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼ 按 -i 间隔输出                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  [CPU] |sched_switch |sched_wakeup|                      │   │
│  │  [000] |12 15 18 20  |8  10 12 14 |                      │   │
│  │  [001] |10 12 14 16  |6  8  10 12 |                      │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

**关键机制：**
1. **hrtimer 作为 leader**: 使用 `PERF_COUNT_SW_CPU_CLOCK` 创建高精度定时器
2. **事件分组**: `-e` 指定的事件作为 group member，与 hrtimer 组成事件组
3. **原子采样**: 定时器到期时，`PERF_SAMPLE_READ` 原子读取组内所有计数器
4. **并行采样**: 每个 CPU 的定时器独立运行，同时采样，不损失精度
5. **精度保证**: 采样粒度由 `--period` 控制，可达微秒级

### stat 低精度计数原理

stat 基于 hrcount 架构，但采用顺序读取方式：

```
┌─────────────────────────────────────────────────────────────────┐
│                          stat 架构                              │
├─────────────────────────────────────────────────────────────────┤
│  内核态                                                         │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  CPU 0         CPU 1         CPU 2         CPU 3        │   │
│  │  ┌───────┐     ┌───────┐     ┌───────┐     ┌───────┐   │   │
│  │  │counter│     │counter│     │counter│     │counter│   │   │
│  │  └───┬───┘     └───┬───┘     └───┬───┘     └───┬───┘   │   │
│  └──────┼─────────────┼─────────────┼─────────────┼────────┘   │
│         │             │             │             │             │
├─────────┼─────────────┼─────────────┼─────────────┼─────────────┤
│  用户态 │             │             │             │             │
│         ▼             ▼             ▼             ▼             │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              顺序读取（按 --period 间隔）                 │   │
│  │  read(cpu0) → read(cpu1) → read(cpu2) → read(cpu3)      │   │
│  │       ↑                                                  │   │
│  │       └── 精度损失：无法同时读取所有CPU的计数器          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼ 累计到 count_dist                │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    按 -i 间隔输出                         │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

**与 hrcount 的差异：**
| 特性 | hrcount | stat |
|------|---------|------|
| 采样方式 | hrtimer 并行采样 | 顺序读取计数器 |
| 精度 | 高（微秒级） | 低（存在时间差） |
| CPU 附加 | 支持 | 支持 |
| 进程附加 | 不支持 | 支持 |
| 适用场景 | CPU 级高精度统计 | 进程级统计 |

### 互补关系

hrcount 和 stat 形成互补：
- **hrcount**: 需要高精度 CPU 级计数时使用
- **stat**: 需要进程级监控或精度要求不高时使用

## 基础用法

```bash
# hrcount: 高精度周期计数（CPU级）
perf-prof hrcount -e <events> -C <cpus> --period <period> -i <interval>

# stat: 低精度周期计数（CPU/进程级）
perf-prof stat -e <events> [-C <cpus>|-p <pid>] --period <period> -i <interval>
```

### OPTION
- `-i, --interval <ms>`: 输出间隔（毫秒），默认 1000ms
- `-m, --mmap-pages`: hrcount 默认 2 页，stat 默认 1 页

### PROFILER OPTION
- `-e, --event <events>`: 指定要统计的事件，支持多个事件逗号分隔
- `--period <ns>`: 采样/读取周期，支持单位：s/ms/us/ns，默认等于 `-i` 间隔
- `--perins`: 按实例（CPU 或线程）分别统计显示

## 输出

### 输出格式

**紧凑模式（默认，hist_size <= 5 且终端宽度足够）**:
```
[CPU] |sched_switch |sched_wakeup|
[000] |12 15 18 20 14|8  10 12 14 9|
[001] |10 12 14 16 11|6  8  10 12 7|
```

**展开模式（hist_size > 5 或终端宽度不足）**:
```
[000] sched:sched_switch 12|15|18|20|14| total 79
[000] sched:sched_wakeup  8|10|12|14| 9| total 53
[001] sched:sched_switch 10|12|14|16|11| total 63
```

### 输出字段
| 字段 | 说明 |
|------|------|
| [CPU]/[THREAD] | 实例标识（CPU 编号或线程 ID） |
| 事件名 | tracepoint 事件名或别名 |
| 计数序列 | 每个 --period 周期内的事件计数 |
| total | 该输出间隔内的事件总数 |

## 应用示例

### 基础示例

```bash
# 1. 监控单个 CPU 上的进程切换（50ms 粒度）
perf-prof hrcount -e sched:sched_switch -C 0 --period 50ms -i 1000

# 2. 监控多个 CPU 上的多个事件
perf-prof hrcount -e sched:sched_switch,sched:sched_wakeup -C 0-5 --period 50ms -i 1000

# 3. 按 CPU 分别显示统计
perf-prof hrcount -e sched:sched_switch -C 0-3 --period 10ms -i 500 --perins
```

### stat 进程级监控

```bash
# 1. 监控特定进程的事件
perf-prof stat -e sched:sched_switch -p 1234 -i 1000 --period 200ms --perins

# 2. CPU 级监控（低精度替代 hrcount）
perf-prof stat -e sched:sched_switch,sched:sched_wakeup -C 0-5 -i 1000
```

### 使用别名简化输出

```bash
# 使用 alias 属性设置事件别名
perf-prof hrcount -e 'sched:sched_switch//alias=switch/,sched:sched_wakeup//alias=wakeup/' \
    -C 0-5 --period 50ms -i 1000

# 不同事件附加到不同 CPU
perf-prof hrcount -e 'sched:sched_switch//cpus="0-2"/,sched:sched_wakeup//cpus="3-4"/' \
    -C 0-5 --period 200ms -i 1000 --perins
```

### 高精度趋势分析

```bash
# 10ms 粒度观察事件波动
perf-prof hrcount -e sched:sched_switch -C 0 --period 10ms -i 1000

# 1ms 粒度（微秒级精度）
perf-prof hrcount -e sched:sched_switch -C 0 --period 1ms -i 500
```

## 选择建议

| 场景 | 推荐工具 | 原因 |
|------|---------|------|
| CPU 级高精度统计 | hrcount | 并行采样，无精度损失 |
| 进程级事件统计 | stat | 支持 -p 进程附加 |
| 低开销长期监控 | stat | 读取开销低于采样 |
| 毫秒级趋势观察 | hrcount | 精度更高 |
| 秒级概览统计 | stat | 精度足够，开销更低 |

## 相关资源
- [top.md](top.md) - 键值聚合统计
- [num-dist.md](num-dist.md) - 数值分布分析
